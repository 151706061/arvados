---
layout: default
navsection: userguide
title: "Using GATK"
navorder: 116
---

h1. Tutorial: Using GATK

This tutorials demonstrates how to use the Genome Analysis Toolkit (GATK) with Arvados. In this example we will install GATK and then create a VariantFiltration job to assign pass/fail scores to variants in a VCF file.

*This tutorial assumes that you are "logged into an Arvados VM instance":{{site.basedoc}}/user/getting_started/ssh-access.html#login, and have a "working environment.":{{site.basedoc}}/user/getting_started/check-environment.html*

h2. Installing GATK

Download the GATK binary tarball[1] -- e.g., @GenomeAnalysisTK-2.6-4.tar.bz2@ -- and "copy it to your Arvados VM":tutorial-keep.html.

<notextile>
<pre><code>$ <span class="userinput">arv keep put GenomeAnalysisTK-2.6-4.tar.bz2</span>
c905c8d8443a9c44274d98b7c6cfaa32+94
</code></pre>
</notextile>

Next, you need the GATK Resource Bundle[2].  This may already be available in Arvados.  If not, you will need to download the files listed below and put them into Keep.

<notextile>
<pre><code>$ <span class="userinput">arv keep ls -s d237a90bae3870b3b033aea1e99de4a9+10820</span>
  50342 1000G_omni2.5.b37.vcf.gz
      1 1000G_omni2.5.b37.vcf.gz.md5
    464 1000G_omni2.5.b37.vcf.idx.gz
      1 1000G_omni2.5.b37.vcf.idx.gz.md5
  43981 1000G_phase1.indels.b37.vcf.gz
      1 1000G_phase1.indels.b37.vcf.gz.md5
    326 1000G_phase1.indels.b37.vcf.idx.gz
      1 1000G_phase1.indels.b37.vcf.idx.gz.md5
 537210 CEUTrio.HiSeq.WGS.b37.bestPractices.phased.b37.vcf.gz
      1 CEUTrio.HiSeq.WGS.b37.bestPractices.phased.b37.vcf.gz.md5
   3473 CEUTrio.HiSeq.WGS.b37.bestPractices.phased.b37.vcf.idx.gz
      1 CEUTrio.HiSeq.WGS.b37.bestPractices.phased.b37.vcf.idx.gz.md5
  19403 Mills_and_1000G_gold_standard.indels.b37.vcf.gz
      1 Mills_and_1000G_gold_standard.indels.b37.vcf.gz.md5
    536 Mills_and_1000G_gold_standard.indels.b37.vcf.idx.gz
      1 Mills_and_1000G_gold_standard.indels.b37.vcf.idx.gz.md5
  29291 NA12878.HiSeq.WGS.bwa.cleaned.raw.subset.b37.sites.vcf.gz
      1 NA12878.HiSeq.WGS.bwa.cleaned.raw.subset.b37.sites.vcf.gz.md5
    565 NA12878.HiSeq.WGS.bwa.cleaned.raw.subset.b37.sites.vcf.idx.gz
      1 NA12878.HiSeq.WGS.bwa.cleaned.raw.subset.b37.sites.vcf.idx.gz.md5
  37930 NA12878.HiSeq.WGS.bwa.cleaned.raw.subset.b37.vcf.gz
      1 NA12878.HiSeq.WGS.bwa.cleaned.raw.subset.b37.vcf.gz.md5
    592 NA12878.HiSeq.WGS.bwa.cleaned.raw.subset.b37.vcf.idx.gz
      1 NA12878.HiSeq.WGS.bwa.cleaned.raw.subset.b37.vcf.idx.gz.md5
5898484 NA12878.HiSeq.WGS.bwa.cleaned.recal.b37.20.bam
    112 NA12878.HiSeq.WGS.bwa.cleaned.recal.b37.20.bam.bai.gz
      1 NA12878.HiSeq.WGS.bwa.cleaned.recal.b37.20.bam.bai.gz.md5
      1 NA12878.HiSeq.WGS.bwa.cleaned.recal.b37.20.bam.md5
   3837 NA12878.HiSeq.WGS.bwa.cleaned.recal.b37.20.vcf.gz
      1 NA12878.HiSeq.WGS.bwa.cleaned.recal.b37.20.vcf.gz.md5
     65 NA12878.HiSeq.WGS.bwa.cleaned.recal.b37.20.vcf.idx.gz
      1 NA12878.HiSeq.WGS.bwa.cleaned.recal.b37.20.vcf.idx.gz.md5
 275757 dbsnp_137.b37.excluding_sites_after_129.vcf.gz
      1 dbsnp_137.b37.excluding_sites_after_129.vcf.gz.md5
   3735 dbsnp_137.b37.excluding_sites_after_129.vcf.idx.gz
      1 dbsnp_137.b37.excluding_sites_after_129.vcf.idx.gz.md5
 998153 dbsnp_137.b37.vcf.gz
      1 dbsnp_137.b37.vcf.gz.md5
   3890 dbsnp_137.b37.vcf.idx.gz
      1 dbsnp_137.b37.vcf.idx.gz.md5
  58418 hapmap_3.3.b37.vcf.gz
      1 hapmap_3.3.b37.vcf.gz.md5
    999 hapmap_3.3.b37.vcf.idx.gz
      1 hapmap_3.3.b37.vcf.idx.gz.md5
      3 human_g1k_v37.dict.gz
      1 human_g1k_v37.dict.gz.md5
      2 human_g1k_v37.fasta.fai.gz
      1 human_g1k_v37.fasta.fai.gz.md5
 849537 human_g1k_v37.fasta.gz
      1 human_g1k_v37.fasta.gz.md5
      1 human_g1k_v37.stats.gz
      1 human_g1k_v37.stats.gz.md5
      3 human_g1k_v37_decoy.dict.gz
      1 human_g1k_v37_decoy.dict.gz.md5
      2 human_g1k_v37_decoy.fasta.fai.gz
      1 human_g1k_v37_decoy.fasta.fai.gz.md5
 858592 human_g1k_v37_decoy.fasta.gz
      1 human_g1k_v37_decoy.fasta.gz.md5
      1 human_g1k_v37_decoy.stats.gz
      1 human_g1k_v37_decoy.stats.gz.md5
</code></pre>
</notextile>

h3. Submit a job.

The Arvados distribution includes an example crunch script ("crunch_scripts/GATK2-VariantFiltration":https://arvados.org/projects/arvados/repository/revisions/master/entry/crunch_scripts/GATK2-VariantFiltration) that runs the GATK VariantFiltration tool with some default settings.

We will pass it the following parameters:

* input -- a collection containing the source VCF data. Here we will use an exome report from PGP participant hu34D5B9.
* gatk_binary_tarball -- a collection containing the GATK 2 tarball.
* gatk_bundle -- a collection containing the GATK resource bundle[2].

<pre>
src_version=76588bfc57f33ea1b36b82ca7187f465b73b4ca4
vcf_input=5ee633fe2569d2a42dd81b07490d5d13+82+K@qr1hi
gatk_binary=c905c8d8443a9c44274d98b7c6cfaa32+94+K@qr1hi
gatk_bundle=d237a90bae3870b3b033aea1e99de4a9+10820+K@qr1hi

read -rd $'\000' the_job <<EOF
{
 "script":"GATK2-VariantFiltration",
 "script_version":"$src_version",
 "script_parameters":
 {
  "input":"$vcf_input",
  "gatk_binary_tarball":"$gatk_binary",
  "gatk_bundle":"$gatk_bundle"
 }
}
EOF

arv -h job create --job "$the_job"
</pre>

Note the job UUID in the API response.

h3. Monitor job progress

<!-- _This was already covered in tutorial1_ -->

There are three ways to monitor job progress:

# Go to Workbench, drop down the Compute menu, and click Jobs. The job you submitted should appear at the top of the list. Hit "Refresh" until it finishes.
# Run @arv -h job get --uuid JOB_UUID_HERE@ to see the job particulars, notably the "tasks_summary" attribute which indicates how many tasks are done/running/todo.
# Watch the crunch log messages and stderr from the job tasks:

<pre>
curl -s -H "Authorization: OAuth2 $ARVADOS_API_TOKEN" \
  https://{{ site.arvados_api_host }}/arvados/v1/jobs/JOB_UUID_HERE/log_tail_follow
</pre>


<!-- _That's it?  Say something about the output we're going to get_ -->

h3. Notes

fn1. Download the GATK tools &rarr; "http://www.broadinstitute.org/gatk/download":http://www.broadinstitute.org/gatk/download

fn2. "Information about the GATK resource bundle":http://gatkforums.broadinstitute.org/discussion/1213/whats-in-the-resource-bundle-and-how-can-i-get-it "Direct download link":ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/2.5/hg18/ (if prompted, just submit an empty password)
