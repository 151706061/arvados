---
layout: default
navsection: installguide
title: Install the Crunch dispatcher
navorder: 3
---

h1. Crunch setup

h4. Perl SDK dependencies

* @apt-get install libjson-perl libwww-perl libio-socket-ssl-perl libipc-system-simple-perl@

h4. Python SDK dependencies

* @apt-get install python-pip@
* @pip install --upgrade google-api-python-client@

h4. Repositories

Crunch scripts must be in git repositories in @/var/cache/git/*/.git@ (or whatever is configured in @services/api/config/environments/production.rb@).

h4. Importing commits

@services/api/script/import_commits.rb production@ must run periodically. Example @/var/service/arvados_import_commits/run@ script for daemontools or runit:

<pre>
#!/bin/sh
set -e
while sleep 60
do
  cd /path/to/arvados/services/api
  setuidgid www-data env RAILS_ENV=production bundle exec ./script/import_commits.rb
done
</pre>

Once you have imported some commits, you should be able to create a new job:

<pre>
read newjob <<EOF; arv job create --job "$newjob"
{"script_parameters":{"input":"f815ec01d5d2f11cb12874ab2ed50daa"},
 "script_version":"master",
 "script":"hash"}
EOF
</pre>

Without getting this error:

<pre>
ArgumentError: Specified script_version does not resolve to a commit
</pre>

h4. Running jobs

* @services/api/script/crunch-dispatch.rb@ must be running.
* @crunch-dispatch.rb@ needs @services/crunch/crunch-job@ in its @PATH@.
* @crunch-job@ needs @sdk/perl/lib@ and @warehouse-apps/libwarehouse-perl/lib@ in its @PERLLIB@
* @crunch-job@ needs @ARVADOS_API_HOST@ (and, if necessary in a development environment, @ARVADOS_API_HOST_INSECURE@)

Example @/var/service/arvados_crunch_dispatch/run@ script:

<pre>
#!/bin/sh
set -e
export PATH="$PATH":/path/to/arvados/services/crunch
export PERLLIB=/path/to/arvados/sdk/perl/lib:/path/to/warehouse-apps/libwarehouse-perl/lib
export ARVADOS_API_HOST=xyzzy.arvadosapi.com

## Only if your SSL cert is unverifiable:
# export ARVADOS_API_HOST_INSECURE=yes

cd /path/to/arvados/services/api
RAILS_ENV=production bundle exec ./script/crunch-dispatch.rb
</pre>
