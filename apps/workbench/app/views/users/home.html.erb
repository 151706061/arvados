<% content_for :head do %>
    <style>
      .dash-list {
        padding: 9px 0;
      }
      .dash-list>ul>li>a>span {
      min-width: 1.5em;
      margin-left: auto;
      margin-right: auto;
      }
      .job-table td {
      overflow-x: hidden;
      }
      .centerme {
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      }
      .bigfatnumber {
      font-size: 4em;
      font-weight: bold;
      }
    </style>
<% end %>

<% if current_user.andand.is_active %>


<% if @my_ssh_keys.count == 0%>
  <div class="alert alert-info">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    <div class="span5" style="overflow: hidden; margin-right: 1em">
      <%= image_tag "dax.png", style: "max-width: 10%; margin-right: 1em; float: left" %>
      Hi, I noticed that you have not yet set up an SSH public key for use with Arvados.  
      <%= link_to "Click here to learn how to create a SSH key pair.",
	  "http://doc.arvados.org/user/getting_started/ssh-access.html", style: "font-weight: bold" %>
      After you have created an SSH key, you can paste your SSH public key
      in the text box.
    </div>
      <%= form_for AuthorizedKey.new do |f| %>
	<%= hidden_field_tag :return_to, request.original_url %>
	<%= f.text_area :public_key, cols: 50, rows: 4, placeholder: "Paste your public key here", style: "width: 45%" %>
	<%= f.submit :Save, value: raw("&check;"), class: "btn btn-primary", style: "vertical-align: top" %>
      <% end %>
  </div>
<% end %>

<% if Collection.limit(1).where(created_by: current_user.uuid).count == 0 %>
<div class="alert alert-block alert-info">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
  <p><%= image_tag "dax.png", style: "max-width: 5%; margin-right: 1em" %>
    Hi, I noticed you haven't uploaded a new collection yet. 
    <%= link_to "Click here to learn how to upload data to Arvados Keep.", "http://doc.arvados.org/user/tutorials/tutorial-keep.html", style: "font-weight: bold" %>
  </p>
</div>

<% end %>

<% if Job.limit(1).where(created_by: current_user.uuid).count == 0 %>
<div class="alert alert-block alert-info">
  <button type="button" class="close" data-dismiss="alert">&times;</button>  
  <p><%= image_tag "dax.png", style: "max-width: 5%; margin-right: 1em" %>
    Hi, I noticed you haven't run a job yet. 
    <%= link_to "Click here to learn how to run an Arvados Crunch job.", "http://doc.arvados.org/user/tutorials/tutorial-job1.html", style: "font-weight: bold" %>
  </p>
</div>
<% end %>

<% if PipelineInstance.limit(1).where(created_by: current_user.uuid).count == 0 %>
<div class="alert alert-block alert-info">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
  <p><%= image_tag "dax.png", style: "max-width: 5%; margin-right: 1em" %>
    Hi, I noticed you haven't run a pipeline yet.  
    <%= link_to "Click here to learn how to run an Arvados Crunch pipeline.", "http://doc.arvados.org/user/tutorials/tutorial-new-pipeline.html", style: "font-weight: bold" %>
  </p>
</div>
<% end %>

<div class="row-fluid">
  <div class="col span12">
    <div class="clearfix">
      <h4>Account summary</h4>
      <div class="well clearfix">
        <% [Human, Trait, Collection, 'File', PipelineTemplate, PipelineInstance].each do |aclass| %>
        <div class="col span2 centerme">
          <span class="bigfatnumber">
            <% if aclass == 'File' %>
            <%= Collection.limit(4000).where({}).collect(&:files).flatten(1).count %>
            <% else %>
            <%= aclass.limit(4000).where({}).count %>
            <% end %>
          </span>
          <br />
          <%= raw(aclass.to_s.pluralize.underscore.gsub '_', '&nbsp;') %>
        </div>
	<% end %>
      </div>
    </div>
  </div>
</div>

<div class="row-fluid">
  <div class="col span3">
    <div class="clearfix">
      <h4>Configuration</h4>
      <div class="well dash-list">
        <ul class="nav nav-list">
          <li class="clearfix">
            <a href="<%= authorized_keys_path %>">
              <span class="pull-left"><%= raw '&#x2714;' if @my_ssh_keys.any? %>&nbsp;</span>
              SSH keys
              <span class="pull-right"><%= @my_ssh_keys.count %></span>
            </a>
          </li>
          <li class="clearfix">
            <a href="<%= virtual_machines_path %>">
              <span class="pull-left"><%= raw '&#x2714;' if @my_vm_perms.any? %>&nbsp;</span>
              Virtual machines
              <span class="pull-right"><%= @my_vm_perms.collect(&:head_uuid).uniq.count %></span>
            </a>
          </li>
          <li class="clearfix">
            <a href="<%= repositories_path %>">
              <span class="pull-left"><%= raw '&#x2714;' if @my_repo_perms.any? %>&nbsp;</span>
              Repositories
              <span class="pull-right"><%= @my_repo_perms.collect(&:head_uuid).uniq.count %></span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="col span4">
    <%= render partial: 'quick_links' %>
  </div>
  <div class="col span5">
    <div class="clearfix">
      <h4>Recent jobs</h4>
      <% if not current_user.andand.is_active or @my_jobs.empty? %>
      (None)
      <% else %>
      <table class="table table-bordered table-condensed job-table">
        <% @my_jobs[0..8].each do |j| %>
        <tr>
          <td>
            <small>
              <%= link_to j.script[0..31], job_path(j.uuid) %>
            </small>
          </td>
          <td>
            <small>
              <%= j.script_version[0..7] %>
            </small>
          </td>
          <td>
            <small>
              <%= j.script_parameters.andand[:input].andand.to_s.andand[0..7] %>
            </small>
          </td>
          <td>
            <% if j.success %>
            <span class="label label-success">finished</span>
            <% elsif j.success == false %>
            <span class="label label-danger">failed</span>
            <% elsif j.running and j.started_at and not j.finished_at %>
            <% percent_total_tasks = 100 / (j.tasks_summary[:running] + j.tasks_summary[:done] + j.tasks_summary[:todo]) rescue 0 %>
            <div class="progress" style="margin-bottom: 0">
              <div class="bar bar-success" style="width: <%= j.tasks_summary[:done] * percent_total_tasks rescue 0 %>%;"></div>
              <div class="bar" style="width: <%= j.tasks_summary[:running] * percent_total_tasks rescue 0 %>%; opacity: 0.3"></div>
            </div>
            <% else %>
            <span class="label">queued</span>
            <% end %>
          </td>
        </tr>
        <% end %>
      </table>
      <%= link_to raw("Show more jobs / details &rarr;"), jobs_path, class: 'pull-right' %>
      <% end %>
    </div>
  </div>
</div>

<% elsif current_user %>
  <%= image_tag "dax.png", style: "float: left; max-width: 25%; margin-right: 2em" %>
  <h1>Welcome to Arvados, <%= current_user.first_name %>!</h1>
  <div class="row-fluid">
    <div class="col span8">
      <h4>Your account status</h4>
      <div class="well clearfix">
	<p><strong>New / inactive</strong></p>
	<p>
	  Your account must be activated by an Arvados administrator.  If this
	  is your first time accessing Arvados and would like to request
	  access, or you believe you are seeing the page in error, please 
	  <%= link_to "contact us", Rails.configuration.activation_contact_link %>.  
	  You should receive an email at the address you used to log in when
	  your account is activated.  In the mean time, you can 
	  <%= link_to "learn more about Arvados", "https://arvados.org/projects/arvados/wiki/Introduction_to_Arvados" %>,
	  and <%= link_to "read the Arvados user guide", "http://doc.arvados.org/user" %>.
	</p>
	<p>
	  <%= link_to raw('Contact us &#x2709;'),
	      Rails.configuration.activation_contact_link, class: "pull-right btn btn-primary" %></p>
      </div>
    </div>
  </div>
<% end %>
